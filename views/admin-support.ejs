<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ | MetaConnect</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f3f4f6; overflow-x: hidden; }
        
        /* Sidebar (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) */
        .sidebar { width: 260px; height: 100vh; background: #111827; color: white; position: fixed; top: 0; right: 0; padding: 25px 15px; z-index: 1000; }
        .sidebar h4 { font-weight: 800; margin-bottom: 50px; letter-spacing: 1px; color: #fff; text-align: center; }
        .sidebar h4 span { color: #3b82f6; }
        .nav-link { color: #9ca3af; padding: 12px 15px; border-radius: 10px; transition: 0.3s; margin-bottom: 8px; display: flex; align-items: center; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #1f2937; color: white; transform: translateX(-5px); }
        .nav-link i { width: 30px; font-size: 1.1rem; margin-left: 10px; }

        /* Main Content */
        .main-content { margin-right: 260px; padding: 40px; }
        
        /* Ticket Card Style */
        .ticket-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-right: 4px solid transparent; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-decoration: none; display: block; color: inherit; }
        .ticket-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #fff; color: inherit; }
        
        .status-open { border-right-color: #dc3545; } /* Ø£Ø­Ù…Ø± Ù„Ù„Ù…ÙØªÙˆØ­ */
        .status-closed { border-right-color: #6c757d; opacity: 0.8; } /* Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ù…ØºÙ„Ù‚ */
        
        .ticket-meta { font-size: 0.85rem; color: #6b7280; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .avatar-circle { width: 35px; height: 35px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #374151; font-size: 0.9rem; }
        
        /* Filters */
        .filter-btn { border-radius: 20px; padding: 8px 20px; font-size: 0.9rem; font-weight: 600; border: 1px solid #e5e7eb; background: white; color: #4b5563; margin-left: 10px; transition: 0.3s; }
        .filter-btn.active { background: #111827; color: white; border-color: #111827; }
        .filter-btn:hover:not(.active) { background: #f9fafb; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-weight: 800; color: #111827; font-size: 1.8rem; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4>Meta<span>Connect</span></h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/admin-dashboard"><i class="fas fa-chart-pie"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</a>
            <a class="nav-link" href="#"><i class="fas fa-building"></i> Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</a>
            <a class="nav-link" href="#"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†</a>
            <a class="nav-link active" href="#"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a>
            
            <div style="margin-top: auto; padding-top: 30px;">
                <a class="nav-link text-danger" href="/logout"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <div class="page-header">
            <div>
                <h2 class="page-title">ğŸ“¥ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
                <p class="text-muted mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©</p>
            </div>
            
            <!-- Notifications Bell -->
            <div class="position-relative">
                <a href="#" class="text-dark fs-4">
                    <i class="fas fa-bell"></i>
                </a>
                <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none; font-size: 0.7rem;">
                    0
                </span>
            </div>
        </div>

        <!-- Filters Toolbar -->
        <div class="d-flex mb-4">
            <button class="filter-btn active" onclick="filterTickets('all', this)">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" onclick="filterTickets('open', this)">ğŸ”´ ÙŠØ­ØªØ§Ø¬ Ø±Ø¯</button>
            <button class="filter-btn" onclick="filterTickets('closed', this)">âš« Ù…ØºÙ„Ù‚</button>
        </div>

        <!-- Tickets List -->
        <div class="row" id="ticketsContainer">
            <% if(tickets.length === 0) { %>
                <div class="col-12 text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" width="80" class="mb-3 opacity-50">
                    <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
                </div>
            <% } else { %>
                <% tickets.forEach(function(ticket) { %>
                    <div class="col-12 ticket-item" data-status="<%= ticket.status %>">
                        <a href="/admin/support/view/<%= ticket.id %>" class="ticket-card status-<%= ticket.status %>">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="fw-bold mb-1 text-dark">
                                        <% if(ticket.status == 'open') { %><i class="fas fa-circle text-danger me-2" style="font-size:0.7rem"></i><% } %>
                                        <%= ticket.subject %>
                                    </h5>
                                    <p class="text-muted mb-2 small text-truncate" style="max-width: 600px;">
                                        Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: #<%= ticket.id %>
                                    </p>
                                </div>
                                <span class="badge bg-<%= ticket.status == 'open' ? 'danger' : 'light text-dark border' %> rounded-pill px-3">
                                    <%= ticket.status == 'open' ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚' %>
                                </span>
                            </div>
                            
                            <div class="ticket-meta pt-2 border-top mt-2">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle ms-2"><%= ticket.dev_name.charAt(0) %></div>
                                    <div>
                                        <span class="d-block fw-bold text-dark"><%= ticket.dev_name %></span>
                                        <span class="d-block" style="font-size:0.75rem">Ù…Ø·ÙˆØ± Ù…Ø¹ØªÙ…Ø¯</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <i class="far fa-clock me-1"></i> <%= new Date(ticket.created_at).toLocaleString('ar-EG') %>
                                </div>
                            </div>
                        </a>
                    </div>
                <% }); %>
            <% } %>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. ÙƒÙˆØ¯ Ø§Ù„ÙÙ„ØªØ±Ø© (JavaScript Client-Side)
        function filterTickets(status, btn) {
            // ØªØ­Ø¯ÙŠØ« Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ°Ø§ÙƒØ±
            const tickets = document.querySelectorAll('.ticket-item');
            tickets.forEach(ticket => {
                if (status === 'all' || ticket.dataset.status === status) {
                    ticket.style.display = 'block';
                    // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ· Ù„Ù„Ø¸Ù‡ÙˆØ±
                    ticket.style.animation = 'fadeIn 0.3s';
                } else {
                    ticket.style.display = 'none';
                }
            });
        }

        // 2. ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Real-time Polling)
        function checkNotifications() {
            fetch('/api/notifications/count')
                .then(res => res.json())
                .then(data => {
                    const badge = document.getElementById('notifBadge');
                    if (data.count > 0) {
                        badge.innerText = data.count;
                        badge.style.display = 'inline-block';
                        badge.classList.add('animate__animated', 'animate__pulse'); // Ù†Ø¨Ø¶ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙŠØ¯
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(err => console.log('Notification check failed'));
        }
        
        setInterval(checkNotifications, 10000); // ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
        checkNotifications(); // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„

        // CSS Animation Keyframe
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(style);
    </script>

</body>
</html>
