<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <title>Ù…Ø­Ø§Ø¯Ø«Ø©: <%= ticket.subject %>
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <style>
        .chat-box {
            height: 450px;
            overflow-y: auto;
            background: #f0f2f5;
            padding: 20px;
            border-radius: 0 0 10px 10px;
        }

        .message {
            max-width: 75%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
        }

        .message.admin {
            background: #d1e7dd;
            margin-right: auto;
            border-bottom-left-radius: 2px;
            color: #0f5132;
        }

        .message.developer {
            background: #fff;
            margin-left: auto;
            border-bottom-right-radius: 2px;
            border: 1px solid #edeeef;
        }

        .msg-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            font-size: 0.9em;
            padding: 5px 10px;
        }

        .company-info-box {
            background: #e7f1ff;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container mt-4 mb-5">
        <div class="row justify-content-center">
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª -->
            <div class="col-lg-8">

                <!-- ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØ§Ù„Ø´Ø±ÙƒØ© -->
                <div class="card shadow-sm mb-3 border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="mb-2">
                                    <%= ticket.subject %> <span class="text-muted fs-6">#<%= ticket.id %></span>
                                </h4>
                                <span
                                    class="badge bg-<%= ticket.status == 'open' ? 'success' : (ticket.status == 'closed' ? 'secondary' : 'warning') %> status-badge mb-2">
                                    <%= ticket.status=='open' ? 'Ù…ÙØªÙˆØ­Ø©' : (ticket.status=='closed' ? 'Ù…ØºÙ„Ù‚Ø©' : 'Ù…Ø¹Ù„Ù‚Ø©'
                                        ) %>
                                </span>
                            </div>
                            <div>
                                <% if(userType==='admin' ) { %>
                                    <a href="/admin/support" class="btn btn-outline-secondary btn-sm">Ø¹ÙˆØ¯Ø©</a>
                                    <% } else { %>
                                        <a href="/dev/support" class="btn btn-outline-secondary btn-sm">Ø¹ÙˆØ¯Ø©</a>
                                        <% } %>
                            </div>
                        </div>

                        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ© (Ù…Ù‡Ù… Ù„Ù„Ø¥Ø¯Ù…Ù†) -->
                        <% if(ticket.company_name) { %>
                            <div class="company-info-box mt-2">
                                <div class="row">
                                    <div class="col-md-4"><strong>ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©:</strong>
                                        <%= ticket.company_name %>
                                    </div>
                                    <div class="col-md-4"><strong>ğŸ”¢ Ø¶Ø±ÙŠØ¨ÙŠ:</strong>
                                        <%= ticket.tax_id %>
                                    </div>
                                    <div class="col-md-4"><strong>ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©:</strong>
                                        <%= ticket.country_code=='EG' ? 'Ù…ØµØ± ğŸ‡ªğŸ‡¬' : 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ğŸ‡¸ğŸ‡¦' %>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ø¥Ø¯Ù…Ù† ÙÙ‚Ø·) -->
                                <% if(userType==='admin' ) { %>
                                    <div class="border-top pt-2 mt-2">
                                        <small class="text-muted fw-bold me-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†:</small>
                                        <% if(ticket.status !=='closed' ) { %>
                                            <form action="/admin/ticket/status" method="POST" class="d-inline">
                                                <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                                <input type="hidden" name="status" value="suspended">
                                                <button class="btn btn-sm btn-warning me-1">â¸ ØªØ¹Ù„ÙŠÙ‚</button>
                                            </form>
                                            <form action="/admin/ticket/status" method="POST" class="d-inline">
                                                <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                                <input type="hidden" name="status" value="closed">
                                                <button class="btn btn-sm btn-dark">ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ</button>
                                            </form>
                                            <% } else { %>
                                                <form action="/admin/ticket/status" method="POST" class="d-inline">
                                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                                    <input type="hidden" name="status" value="open">
                                                    <button class="btn btn-sm btn-success">ğŸ”“ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­</button>
                                                </form>
                                                <% } %>
                                    </div>
                                    <% } %>
                    </div>
                </div>

                <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
                <div class="card shadow-sm border-0">
                    <div class="card-body chat-box" id="chatBox">
                        <% messages.forEach(function(msg) { %>
                            <div class="message <%= msg.sender_type %> shadow-sm">
                                <div class="d-flex justify-content-between mb-1">
                                    <strong>
                                        <%= msg.sender_type=='admin' ? 'ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ' : 'ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„' %>
                                    </strong>
                                    <small class="text-muted" style="font-size: 0.7em">
                                        <%= msg.created_at.toLocaleString() %>
                                    </small>
                                </div>

                                <% if(msg.attachment) { %>
                                    <div class="mb-2">
                                        <a href="/uploads/<%= msg.attachment %>" target="_blank">
                                            <img src="/uploads/<%= msg.attachment %>" class="msg-img"
                                                title="Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±">
                                        </a>
                                    </div>
                                    <% } %>

                                        <div style="white-space: pre-wrap;">
                                            <%= msg.message %>
                                        </div>
                            </div>
                            <% }); %>
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªØ®ØªÙÙŠ Ù„Ùˆ Ù…ØºÙ„Ù‚) -->
                    <div class="card-footer bg-white p-3">
                        <% if(ticket.status !=='closed' || userType==='admin' ) { %>
                            <form action="/support/reply" method="POST" enctype="multipart/form-data"
                                class="d-flex align-items-center">
                                <input type="hidden" name="ticket_id" value="<%= ticket.id %>">

                                <!-- Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
                                <label class="btn btn-light border me-2" style="cursor: pointer;" title="Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©">
                                    ğŸ“· <input type="file" name="image" style="display: none;" accept="image/*">
                                </label>

                                <input type="text" name="message" class="form-control me-2"
                                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." autocomplete="off">
                                <button type="submit" class="btn btn-primary px-4">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
                            </form>
                            <% } else { %>
                                <div class="alert alert-secondary mb-0 text-center">
                                    ğŸ”’ Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ÙˆØ¯ Ø¬Ø¯ÙŠØ¯Ø©.
                                </div>
                                <% } %>
                    </div>
                </div>
            </div>

            <!-- (Ù„Ù„Ø¥Ø¯Ù…Ù† ÙÙ‚Ø·) Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
            <% if(userType==='admin' && developer) { %>
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="card border-success shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-success text-white fw-bold">ğŸ’° Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø³Ø±ÙŠØ¹</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <div class="fw-bold">
                                    <%= developer.name %>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                                <div class="fw-bold text-success fs-4">
                                    <%= developer.wallet_balance %> <small>Ø¬.Ù…</small>
                                </div>
                            </div>
                            <hr>
                            <form action="/admin/add-balance" method="POST">
                                <input type="hidden" name="developer_id" value="<%= developer.id %>">
                                <label class="form-label small fw-bold">Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ø­Ù†</label>
                                <div class="input-group">
                                    <input type="number" name="amount" class="form-control" placeholder="0.00" required>
                                    <button class="btn btn-success" type="submit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <% } %>
        </div>
    </div>

    <script>
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;

        function refreshChat() {
            const ticketId = '<%= ticket.id %>';
            fetch(`/api/support/messages/${ticketId}`)
                .then(response => response.json())
                .then(messages => {
                    const chatBox = document.getElementById('chatBox');
                    const currentScroll = chatBox.scrollTop;
                    const isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 150;

                    chatBox.innerHTML = '';

                    messages.forEach(msg => {
                        let attachmentHtml = '';
                        if (msg.attachment) {
                            attachmentHtml = `<div class="mb-2"><a href="/uploads/${msg.attachment}" target="_blank"><img src="/uploads/${msg.attachment}" class="msg-img"></a></div>`;
                        }

                        const div = document.createElement('div');
                        div.className = `message ${msg.sender_type} shadow-sm`;
                        div.innerHTML = `
                            <div class="d-flex justify-content-between mb-1">
                                <strong>${msg.sender_type == 'admin' ? 'ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ' : 'ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„'}</strong>
                                <small class="text-muted" style="font-size: 0.7em">${new Date(msg.created_at).toLocaleString()}</small>
                            </div>
                            ${attachmentHtml}
                            <div style="white-space: pre-wrap;">${msg.message}</div>
                        `;
                        chatBox.appendChild(div);
                    });

                    if (isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
                    else chatBox.scrollTop = currentScroll;
                });
        }

        // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(refreshChat, 3000);
    </script>
    <script>
        // Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØ­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)
        const currentTicketId = '<%= ticket.id %>';
        let currentStatus = '<%= ticket.status %>';

        function checkTicketStatus() {
            // Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ°ÙƒØ±Ø©
            fetch(`/api/ticket/status/${currentTicketId}`)
                .then(response => response.json())
                .then(data => {
                    // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù† Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹
                    if (data.status !== currentStatus) {
                        // Ù†Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ùˆ Ù†Ø­Ø¯Ø« Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹
                        location.reload();
                    }
                })
                .catch(err => console.error(err));
        }

        // ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(checkTicketStatus, 5000);
    </script>

</body>

</html>