<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ø§Ø¯Ø«Ø©: <%= ticket.subject %> | MetaConnect</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f3f4f6; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: #111827; color: white; position: fixed; top: 0; right: 0; padding: 25px 15px; z-index: 1000; }
        .sidebar h4 { font-weight: 800; margin-bottom: 50px; letter-spacing: 1px; color: #fff; text-align: center; }
        .sidebar h4 span { color: #3b82f6; }
        .nav-link { color: #9ca3af; padding: 12px 15px; border-radius: 10px; transition: 0.3s; margin-bottom: 8px; display: flex; align-items: center; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #1f2937; color: white; transform: translateX(-5px); }
        .nav-link i { width: 30px; font-size: 1.1rem; margin-left: 10px; }

        /* Main Content */
        .main-content { margin-right: 260px; padding: 40px; }

        /* Chat Specific Styles */
        .chat-container { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; height: calc(100vh - 100px); display: flex; flex-direction: column; }
        
        .chat-header { padding: 20px; border-bottom: 1px solid #e5e7eb; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f9fafb; }
        
        .message { max-width: 75%; margin-bottom: 20px; padding: 15px; border-radius: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .message.admin { background: #eff6ff; color: #1e40af; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid #dbeafe; }
        .message.developer { background: #f0fdf4; color: #166534; margin-left: auto; border-bottom-right-radius: 2px; border: 1px solid #dcfce7; }
        .message.store { background: #fff; color: #374151; margin-left: auto; border-bottom-right-radius: 2px; border: 1px solid #e5e7eb; }
        
        .chat-input { padding: 20px; background: white; border-top: 1px solid #e5e7eb; }
        
        .status-badge { font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; }
        .msg-img { max-width: 200px; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .msg-img:hover { transform: scale(1.05); }

        /* Info Sidebar */
        .info-panel { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); height: fit-content; }
    </style>
</head>
<body>

    <!-- Sidebar (Dynamic Content) -->
    <div class="sidebar">
        <h4>Meta<span>Connect</span></h4>
        <nav class="nav flex-column">
            
            <% if (userType === 'admin') { %>
                <!-- ğŸ”´ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù† -->
                <a class="nav-link" href="/admin-dashboard"><i class="fas fa-chart-pie"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</a>
                <a class="nav-link" href="#"><i class="fas fa-building"></i> Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</a>
                <a class="nav-link active" href="/admin/support"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a>
            
            <% } else if (userType === 'developer') { %>
                <!-- ğŸŸ¢ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø·ÙˆØ± -->
                <a class="nav-link" href="/dev-dashboard"><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                <a class="nav-link active" href="/dev/support"><i class="fas fa-headset"></i> Ù…Ø±ÙƒØ² Ø§Ù„ØªØ°Ø§ÙƒØ±</a>
                <a class="nav-link" href="/docs"><i class="fas fa-code"></i> Ø§Ù„ØªÙˆØ«ÙŠÙ‚</a>

            <% } else { %>
                <!-- ğŸ”µ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± -->
                <a class="nav-link" href="/store-portal"><i class="fas fa-store"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</a>
                <a class="nav-link active" href="/store/support"><i class="fas fa-life-ring"></i> ØªØ°Ø§ÙƒØ±ÙŠ</a>
            <% } %>

            <div style="margin-top: auto; padding-top: 30px;">
                <a class="nav-link text-danger" href="/logout"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="row h-100">
            
            <!-- Chat Area -->
            <div class="col-lg-8 h-100">
                <div class="chat-container">
                    <!-- Header -->
                    <div class="chat-header">
                        <div>
                            <h5 class="mb-1 fw-bold">
                                <span class="text-muted">#<%= ticket.id %></span> <%= ticket.subject %>
                            </h5>
                            <% 
                                let statusClass = 'secondary';
                                let statusText = 'Ù…ØºÙ„Ù‚Ø©';
                                if(ticket.status == 'open') { statusClass = 'success'; statusText = 'Ù…ÙØªÙˆØ­Ø©'; }
                                if(ticket.status == 'suspended') { statusClass = 'warning text-dark'; statusText = 'Ù…Ø¹Ù„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹'; }
                            %>
                            <span class="badge bg-<%= statusClass %> status-badge">
                                <%= statusText %>
                            </span>
                            
                            <!-- Ø¹Ù„Ø§Ù…Ø© ØªÙˆØ¶Ø­ Ù„Ù…Ù† Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙˆØ¬Ù‡Ø© -->
                            <% if(ticket.is_direct_to_admin) { %>
                                <span class="badge bg-dark ms-2 small" title="Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"><i class="fas fa-building"></i> Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                            <% } else { %>
                                <span class="badge bg-info text-dark ms-2 small" title="Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„ÙˆÙƒÙŠÙ„"><i class="fas fa-user-tie"></i> Ù…Ø¹ Ø§Ù„ÙˆÙƒÙŠÙ„</span>
                            <% } %>
                        </div>
                        <div>
                            <% 
                                let backLink = '/login';
                                if(userType === 'admin') backLink = '/admin/support';
                                else if(userType === 'developer') backLink = '/dev/support';
                                else backLink = '/store/support';
                            %>
                            <a href="<%= backLink %>" class="btn btn-outline-secondary btn-sm px-3 rounded-pill">
                                <i class="fas fa-arrow-right me-1"></i> Ø¹ÙˆØ¯Ø©
                            </a>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="chat-messages" id="chatBox">
                        <% messages.forEach(function(msg) { %>
                            <div class="message <%= msg.sender_type %>">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold small">
                                        <% if(msg.sender_type === 'admin') { %>
                                            <i class="fas fa-shield-alt me-1 text-primary"></i> Ø§Ù„Ø¯Ø¹Ù… (Admin)
                                        <% } else if(msg.sender_type === 'developer') { %>
                                            <i class="fas fa-code me-1 text-success"></i> Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„ÙˆÙƒÙŠÙ„)
                                        <% } else { %>
                                            <i class="fas fa-store me-1 text-secondary"></i> Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ù„Ø¹Ù…ÙŠÙ„)
                                        <% } %>
                                    </span>
                                    <span class="text-muted opacity-75" style="font-size: 0.7rem">
                                        <%= new Date(msg.created_at).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) %>
                                    </span>
                                </div>
                                
                                <div style="white-space: pre-wrap; line-height: 1.6;"><%= msg.message %></div>
                                
                                <% if(msg.attachment) { %>
                                    <a href="/uploads/<%= msg.attachment %>" target="_blank">
                                        <img src="/uploads/<%= msg.attachment %>" class="msg-img" alt="Ù…Ø±ÙÙ‚">
                                    </a>
                                <% } %>
                            </div>
                        <% }); %>
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input">
                        <% if(ticket.status !== 'closed' || userType === 'admin') { %>
                            <form action="/support/reply" method="POST" enctype="multipart/form-data" class="d-flex gap-2">
                                <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                
                                <!-- Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Vercel) -->
                                <label class="btn btn-light border disabled" title="Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© (ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹)" style="padding: 10px 15px; opacity: 0.5; cursor: not-allowed;">
                                    <i class="fas fa-paperclip text-muted"></i>
                                    <!-- <input type="file" name="image" style="display: none;" accept="image/*"> -->
                                </label>
                                
                                <input type="text" name="message" class="form-control border-0 bg-light" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." style="padding: 10px 15px;" required autocomplete="off">
                                
                                <button type="submit" class="btn btn-primary px-4 rounded-3">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        <% } else { %>
                            <div class="alert alert-secondary mb-0 text-center py-2 small">
                                <i class="fas fa-lock me-1"></i> Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø©.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Side Panel (Info & Actions) -->
            <div class="col-lg-4">
                
                <!-- Actions Panel (Admin Only) -->
                <% if(userType === 'admin') { %>
                    <div class="info-panel mb-3 border-warning border-top border-4">
                        <h6 class="fw-bold text-dark mb-3 small"><i class="fas fa-cog me-1"></i> ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h6>
                        <div class="d-grid gap-2">
                            <% if(ticket.status === 'closed') { %>
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="open">
                                    <button class="btn btn-success w-100 btn-sm">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                                </form>
                            <% } else { %>
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="closed">
                                    <button class="btn btn-dark w-100 btn-sm">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                <% } %>

                <!-- Ticket Info -->
                <div class="info-panel mb-3">
                    <h6 class="fw-bold text-muted mb-3 small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©</h6>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØµØ§Ø­Ø¨ Ø§Ù„Ù…ØªØ¬Ø±)</small>
                        <div class="fw-bold"><i class="fas fa-store me-1 text-primary"></i> <%= ticket.company_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' %></div>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</small>
                        <div class="font-monospace bg-light p-1 rounded d-inline-block px-2"><%= ticket.tax_id || '---' %></div>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­</small>
                        <div class="small"><%= new Date(ticket.created_at).toLocaleString('ar-EG') %></div>
                    </div>
                </div>

                <!-- Quick Balance (Admin Only - if developer exists) -->
                <% if(userType === 'admin' && typeof developer !== 'undefined' && developer) { %>
                    <div class="info-panel bg-success text-white" style="background: linear-gradient(45deg, #10b981, #059669);">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-wallet me-2"></i> Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„</h6>
                            <span class="badge bg-white text-success"><%= developer.wallet_balance %> Ø¬.Ù…</span>
                        </div>
                        <form action="/admin/add-balance" method="POST">
                            <input type="hidden" name="developer_id" value="<%= developer.id %>">
                            <div class="input-group">
                                <input type="number" name="amount" class="form-control border-0" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº..." required style="opacity: 0.9;">
                                <button class="btn btn-dark" type="submit">Ø´Ø­Ù†</button>
                            </div>
                        </form>
                        <small class="mt-2 d-block opacity-75" style="font-size: 0.75rem;">* Ù‡Ø°Ø§ Ø§Ù„Ø±ØµÙŠØ¯ ÙŠØ¶Ø§Ù Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ (Developer)</small>
                    </div>
                <% } %>
            </div>

        </div>
    </div>

    <script>
        // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;

        // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        function refreshChat() {
            const ticketId = '<%= ticket.id %>';
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ API ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
            fetch(`/api/support/messages/${ticketId}`)
                .then(response => {
                    if(response.ok) return response.json();
                    throw new Error('Network response was not ok');
                })
                .then(messages => {
                    const currentCount = chatBox.querySelectorAll('.message').length;
                    
                    // Ø¥Ø°Ø§ Ø²Ø§Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙˆÙ…ÙŠØ¶)
                    if(messages.length > currentCount) {
                        chatBox.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        messages.forEach(msg => {
                            // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„
                            let senderName = 'Ø¹Ù…ÙŠÙ„';
                            let icon = 'fa-user';
                            
                            if(msg.sender_type === 'admin') { senderName = 'Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ'; icon = 'fa-shield-alt'; }
                            else if(msg.sender_type === 'developer') { senderName = 'Ø§Ù„ÙˆÙƒÙŠÙ„'; icon = 'fa-code'; }
                            
                            chatBox.innerHTML += `
                                <div class="message ${msg.sender_type}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold small"><i class="fas ${icon} me-1"></i> ${senderName}</span>
                                        <span class="text-muted" style="font-size: 0.7rem">Ø§Ù„Ø¢Ù†</span>
                                    </div>
                                    <div style="white-space: pre-wrap; line-height: 1.6;">${msg.message}</div>
                                </div>
                            `;
                        });
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                })
                .catch(e => console.log('Auto-refresh paused'));
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(refreshChat, 5000);
    </script>

</body>
</html>
