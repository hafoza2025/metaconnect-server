<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ø§Ø¯Ø«Ø©: <%= ticket.subject %> | MetaConnect</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f3f4f6; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: #111827; color: white; position: fixed; top: 0; right: 0; padding: 25px 15px; z-index: 1000; }
        .sidebar h4 { font-weight: 800; margin-bottom: 50px; letter-spacing: 1px; color: #fff; text-align: center; }
        .sidebar h4 span { color: #3b82f6; }
        .nav-link { color: #9ca3af; padding: 12px 15px; border-radius: 10px; transition: 0.3s; margin-bottom: 8px; display: flex; align-items: center; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #1f2937; color: white; transform: translateX(-5px); }
        .nav-link i { width: 30px; font-size: 1.1rem; margin-left: 10px; }

        /* Main Content */
        .main-content { margin-right: 260px; padding: 40px; }

        /* Chat Specific Styles */
        .chat-container { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; height: calc(100vh - 100px); display: flex; flex-direction: column; }
        
        .chat-header { padding: 20px; border-bottom: 1px solid #e5e7eb; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f9fafb; }
        
        .message { max-width: 75%; margin-bottom: 20px; padding: 15px; border-radius: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message.admin { background: #eff6ff; color: #1e40af; margin-right: auto; border-bottom-left-radius: 2px; }
        .message.developer { background: #fff; border: 1px solid #e5e7eb; margin-left: auto; border-bottom-right-radius: 2px; }
        
        .chat-input { padding: 20px; background: white; border-top: 1px solid #e5e7eb; }
        
        .status-badge { font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; }
        .msg-img { max-width: 200px; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .msg-img:hover { transform: scale(1.05); }

        /* Info Sidebar */
        .info-panel { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); height: fit-content; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4>Meta<span>Connect</span></h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/admin-dashboard"><i class="fas fa-chart-pie"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</a>
            <a class="nav-link" href="#"><i class="fas fa-building"></i> Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</a>
            <a class="nav-link" href="#"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†</a>
            <a class="nav-link active" href="/admin/support"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a>
            
            <div style="margin-top: auto; padding-top: 30px;">
                <a class="nav-link text-danger" href="/logout"><i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="row h-100">
            
            <!-- Chat Area -->
            <div class="col-lg-8 h-100">
                <div class="chat-container">
                    <!-- Header -->
                    <div class="chat-header">
                        <div>
                            <h5 class="mb-1 fw-bold">
                                <span class="text-muted">#<%= ticket.id %></span> <%= ticket.subject %>
                            </h5>
                            <% 
                                let statusClass = 'secondary';
                                let statusText = 'Ù…ØºÙ„Ù‚Ø©';
                                if(ticket.status == 'open') { statusClass = 'success'; statusText = 'Ù…ÙØªÙˆØ­Ø©'; }
                                if(ticket.status == 'suspended') { statusClass = 'warning text-dark'; statusText = 'Ù…Ø¹Ù„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹'; }
                            %>
                            <span class="badge bg-<%= statusClass %> status-badge">
                                <%= statusText %>
                            </span>
                        </div>
                        <div>
                            <a href="<%= userType === 'admin' ? '/admin/support' : '/dev/support' %>" class="btn btn-outline-secondary btn-sm px-3 rounded-pill">
                                <i class="fas fa-arrow-right me-1"></i> Ø¹ÙˆØ¯Ø©
                            </a>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="chat-messages" id="chatBox">
                        <% messages.forEach(function(msg) { %>
                            <div class="message <%= msg.sender_type %>">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold small">
                                        <% if(msg.sender_type == 'admin') { %>
                                            <i class="fas fa-headset me-1"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
                                        <% } else { %>
                                            <i class="fas fa-user me-1"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„
                                        <% } %>
                                    </span>
                                    <span class="text-muted" style="font-size: 0.7rem">
                                        <%= new Date(msg.created_at).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) %>
                                    </span>
                                </div>
                                
                                <div style="white-space: pre-wrap; line-height: 1.6;"><%= msg.message %></div>
                                
                                <% if(msg.attachment) { %>
                                    <a href="/uploads/<%= msg.attachment %>" target="_blank">
                                        <img src="/uploads/<%= msg.attachment %>" class="msg-img" alt="Ù…Ø±ÙÙ‚">
                                    </a>
                                <% } %>
                            </div>
                        <% }); %>
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input">
                        <% if(ticket.status !== 'closed' && ticket.status !== 'suspended' || userType === 'admin') { %>
                            <form action="/support/reply" method="POST" enctype="multipart/form-data" class="d-flex gap-2">
                                <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                
                                <label class="btn btn-light border" title="Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©" style="padding: 10px 15px;">
                                    <i class="fas fa-paperclip text-muted"></i>
                                    <input type="file" name="image" style="display: none;" accept="image/*">
                                </label>
                                
                                <input type="text" name="message" class="form-control border-0 bg-light" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." style="padding: 10px 15px;" autocomplete="off">
                                
                                <button type="submit" class="btn btn-primary px-4 rounded-3">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        <% } else { %>
                            <div class="alert alert-secondary mb-0 text-center py-2 small">
                                <i class="fas fa-lock me-1"></i> Ù‡Ø°Ù‡ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ØºÙ„Ù‚Ø© Ø£Ùˆ Ù…Ø¹Ù„Ù‚Ø©.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Side Panel (Info & Actions) -->
            <div class="col-lg-4">
                
                <!-- Actions Panel -->
                <% if(userType === 'admin') { %>
                    <div class="info-panel mb-3">
                        <h6 class="fw-bold text-muted mb-3 small"><i class="fas fa-cog me-1"></i> Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ°ÙƒØ±Ø©</h6>
                        <div class="d-grid gap-2">
                            
                            <% if(ticket.status === 'closed') { %>
                                <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØªØ­ -->
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="open">
                                    <button class="btn btn-success w-100"><i class="fas fa-unlock me-2"></i> Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­</button>
                                </form>

                            <% } else if(ticket.status === 'suspended') { %>
                                <!-- Ø²Ø± ÙÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ + Ø¥ØºÙ„Ø§Ù‚ -->
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="open">
                                    <button class="btn btn-outline-success w-100 fw-bold"><i class="fas fa-play me-2"></i> ÙÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (ØªÙ†Ø´ÙŠØ·)</button>
                                </form>
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="closed">
                                    <button class="btn btn-dark w-100"><i class="fas fa-check-circle me-2"></i> Ø¥ØºÙ„Ø§Ù‚ Ù†Ù‡Ø§Ø¦ÙŠ</button>
                                </form>

                            <% } else { %>
                                <!-- Ø²Ø± ØªØ¹Ù„ÙŠÙ‚ + Ø¥ØºÙ„Ø§Ù‚ -->
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="suspended">
                                    <button class="btn btn-warning w-100"><i class="fas fa-pause me-2"></i> ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                                </form>
                                <form action="/admin/ticket/status" method="POST">
                                    <input type="hidden" name="ticket_id" value="<%= ticket.id %>">
                                    <input type="hidden" name="status" value="closed">
                                    <button class="btn btn-dark w-100"><i class="fas fa-check-circle me-2"></i> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                                </form>
                            <% } %>

                        </div>
                    </div>
                <% } %>

                <!-- Ticket Info -->
                <div class="info-panel mb-3">
                    <h6 class="fw-bold text-muted mb-3 small">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h6>
                    <% if(ticket.company_name) { %>
                        <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                            <div class="bg-white p-2 rounded shadow-sm text-primary fs-5 ms-2">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <div class="fw-bold"><%= ticket.company_name %></div>
                                <small class="text-muted font-monospace">Tax: <%= ticket.tax_id %></small>
                            </div>
                        </div>
                    <% } %>
                </div>

                <!-- Quick Balance (Admin Only) -->
                <% if(userType === 'admin' && developer) { %>
                    <div class="info-panel bg-success text-white" style="background: linear-gradient(45deg, #10b981, #059669);">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-wallet me-2"></i> Ø´Ø­Ù† Ø³Ø±ÙŠØ¹</h6>
                            <span class="badge bg-white text-success"><%= developer.wallet_balance %> Ø¬.Ù…</span>
                        </div>
                        <form action="/admin/add-balance" method="POST">
                            <input type="hidden" name="developer_id" value="<%= developer.id %>">
                            <div class="input-group">
                                <input type="number" name="amount" class="form-control border-0" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº..." required style="opacity: 0.9;">
                                <button class="btn btn-dark" type="submit">Ø´Ø­Ù†</button>
                            </div>
                        </form>
                    </div>
                <% } %>
            </div>

        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;

        function refreshChat() {
            const ticketId = '<%= ticket.id %>';
            fetch(`/api/support/messages/${ticketId}`)
                .then(response => response.json())
                .then(messages => {
                    const isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 150;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· (ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ù„ÙŠØ¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·)
                    if(chatBox.children.length !== messages.length) {
                        chatBox.innerHTML = '';
                        messages.forEach(msg => {
                            let attachHtml = msg.attachment ? `<a href="/uploads/${msg.attachment}" target="_blank"><img src="/uploads/${msg.attachment}" class="msg-img"></a>` : '';
                            const senderClass = msg.sender_type;
                            const senderName = msg.sender_type == 'admin' ? 'ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ' : 'ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„';
                            
                            chatBox.innerHTML += `
                                <div class="message ${senderClass}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold small">${senderName}</span>
                                        <span class="text-muted" style="font-size: 0.7rem">${new Date(msg.created_at).toLocaleTimeString('ar-EG')}</span>
                                    </div>
                                    <div style="white-space: pre-wrap; line-height: 1.6;">${msg.message}</div>
                                    ${attachHtml}
                                </div>
                            `;
                        });
                        if(isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
                    }
                });
        }
        setInterval(refreshChat, 3000);
    </script>

</body>
</html>
